# スケルトンの作成

アドオン開発の第一歩として、以下のような単純な機能を持つ「スケルトン」アドオンを実装します。

スケルトンは以下の機能を持つものとします。

- 任意のプロジェクトにてスケルトンを有効化可能
- スケルトンは `param_1` というパラメータを持ち、プロジェクトごとに異なる値を設定することができる
- `param_1` パラメータはプロジェクトのアドオン設定画面で設定することができる

## 前提条件

[開発環境の準備](../README.md#開発環境でRDMを起動する)のガイドに従い、開発環境にてRDMを起動しているものとします。

# RDMアドオンの設計

## ファイルの構成

RDMにおいてアドオンは[Django](https://www.djangoproject.com/)アプリケーションの形式で記述されます。以下のようなファイルから構成されます。

*TBD*
(Generated by https://github.com/thebjorn/pydeps)

典型的なファイル配置は以下のようになります。

```
/addons/アドオン名/
├── __init__.py ... モジュールの定義
├── apps.py ... アプリケーションの定義
├── models.py ... モデルの定義
├── requirements.txt ... 利用するPythonモジュールの定義
├── routes.py ... View(Routes)の定義
├── settings ... 設定を定義するモジュール。ここにlocal.pyを配置することでカスタマイズできる。
│   ├── defaults.py ... デフォルト設定の定義
│   └── __init__.py ... 設定の定義
├── static ... Webブラウザから読み込むことを想定した静的ファイル
│   ├── comicon.png ... Addonのアイコン
│   └── node-cfg.js ... Node設定を定義するJavaScriptファイル
├── templates ... テンプレートディレクトリ
│   └── node_settings.mako ... Node設定パネル
├── tests ... テストコード
│   ├── conftest.py
│   ├── factories.py
│   ├── test_model.py
│   ├── test_view.py
│   └── utils.py
└── views.py ... View(Views)の定義
```

## アドオンのモジュール構成

アドオンはDjangoの作法に従い、Model-Viewアーキテクチャにより実装します。それぞれの責務は以下のように分担されます。

- Model ... UserとNodeそれぞれに対応したモデルを実装する。それぞれのモデルには認証情報やプロジェクト固有の情報を格納することができる
- View ... Addonに応じた設定、データ取得、保存処理など、HTTP上のエンドポイント(パス)を定義する

Modelはフレームワークにより自動的にそれぞれの利用者、プロジェクトに対応して生成、管理され、永続化されるのに対し、Viewはアプリケーションがロードされる際に構築されます。フレームワークによりそれぞれのライフサイクルが適切に管理されるので、アドオン開発者は機能面の実装に注力することができます。

### Modelの構成

*TBD*

ModelにはUserとNodeそれぞれの情報を格納するためのクラスを定義します。

UserSettingsは利用者ごとにインスタンスが生成され、永続化されます。また、NodeSettingsはプロジェクトごとにインスタンスが生成、永続化されます。これらのインスタンスの生成や破棄をアドオンのコードが行うことは原則としてありません。

スケルトンの場合、以下のようなModelを定義します。

- [addons.myskelton.NodeSettings](addon/models.py)

NodeSettingsは永続化すべきプロパティと、各種setterとgetterを定義しています。

### Viewの構成

*TBD*

Viewは[FlaskのPluggable Views](http://flask.pocoo.org/docs/0.10/views/)のように、サービス上のパスと処理の関係を定義します。定義はRoutesとViewsの2種類の要素から構成されます。

- Routes ... View処理をどのパスにマッピングし、どのような形式で出力するか。出力にはJSON形式や、HTMLのテンプレートを指定することができる
- Views ... View処理の内容

Routesは以下のようにパスとMethod(GET, POST, PUT, DELETE, ...)と、その組み合わせに対してどの関数を実行するか、その実行結果をどのように出力するかを定義します。

各View処理には、その処理の実行における前提をPythonのデコレータの形で記述することができます。指定可能なデコレータには以下のようなものがあります。

- framework.auth.decorators.must_be_logged_in ... ユーザがログインしている状態である場合にのみ呼び出し可能であることを宣言する。引数にはauthパラメータが追加され、認証しているユーザに関する情報を得ることができる
- website.project.decorators.must_have_addon ... Addonに関する情報を必要とすることを宣言する。第1引数にはAddon名を(例では swift)、第2引数には'user'か'node'のいずれかを定義する。('node'にした場合は、パスは /project/<pid>/ から始める必要がある)
- website.project.decorators.must_have_permission ... 必要なパーミッションを宣言する。引数には'write', 'read', 'admin'のいずれかを指定する。

コンテキストに応じてデコレータを宣言しておくことで、Viewの処理の中でModel(利用者が操作対象としているUserやNode)を参照することができます。

### フレームワークによって提供されるView

*TBD*

Routes, Viewsを使うことでさまざまなAPI, インタフェースを定義することができますが、アドオンが持つUser用設定画面とNode用設定画面はフレームワークによってあらかじめテンプレート化されています。(以下はOpenStack Swift Addonの例 /addons/swift/templates/swift_user_settings.mako)

OSF上のViewとして組み込む場合、JavaScriptのライブラリにはKnockout.jsを利用することができます。JavaScriptコードについては、Addonのstaticディレクトリにて定義することができます。(以下はOpenStack Swift Addonの例 /addons/swift/static/user-cfg.js)

# スケルトンの実装

[スケルトンコードの例](addon/)を `addons/myskelton` としてコピーします。

アドオン名を`myskelton`から変更したい場合は、以下のコードを変更してください。

- [SHORT_NAME](addon/__init__.py)
- [view関数のプレフィックス](addon/views.py)

# スケルトンの登録

## addons.json への追加

`addons.json` に、アドオンに関する情報を追加します。

- `addons` ... 利用可能なアドオン一覧。必ず登録する
- `addons_default` ... プロジェクト作成時にデフォルトで有効になるアドオン一覧
- `addons_archivable` ... アドオンごとのアーカイブに関する情報
- `addons_commentable` ... コメント可能なアドオン一覧
- `addons_description` ... アドオン名と説明の定義

```
"myskelton": "My Skelton Addon is ..."
```

- `addons_url` ... アドオンの関連URLの定義

```
"myskelton": "https://dummy.nii.ac.jp/myskelton"
```

変更例は

## addons.json (framework)への追加

`framework/addons/data/addons.json` に、アドオン登録時のメッセージリソースを登録します。
`addons` オブジェクトに、アドオンの完全名をキーとして情報を登録します。

```
"My Skelton": {
    "Permissions": {
        "status": "none",
        "text": "The GakuNin RDM does not affect the permissions of My Skelton."
    },
    "View / download file versions": {
        "status": "none",
        "text": "The My Skelton add-on does not provide Storage Features."
    },
    "Add / update files": {
        "status": "none",
        "text": "The My Skelton add-on does not provide Storage Features."
    },
    "Delete files": {
        "status": "none",
        "text": "The My Skelton add-on does not provide Storage Features."
    },
    "Logs": {
        "status": "none",
        "text": "The My Skelton add-on does not provide Storage Features."
    },
    "Forking": {
        "status": "partial",
        "text": "Forking a project or component copies information about linked My Skelton but the GakuNin RDM does not affect authentication of My Skelton."
    },
    "Registering": {
        "status": "none",
        "text": "My Skelton information will not be registered."
    }
}
```

## Dockerfile への追加

```
#COPY ./addons/myskelton/requirements.txt ./addons/myskelton/
```

```
COPY ./addons/アドオン名/static/ ./addons/アドオン名/static/
```

## defaults.py への追加

`api/base/settings/defaults.py` の `INSTALLED_APPS` にアドオン名を追加します。

```
'addons.myskelton',
```

# Migrationsファイルの作成

*TBD*

```
$ docker-compose run --rm web python3 manage.py makemigrations
```

# スケルトンのテスト

*TBD*

```
$ docker-compose run --rm web invoke test_module -m addons/myskelton/tests/
```

# スケルトンの動作確認

*TBD*

```
$ docker-compose run --rm web python3 manage.py migrate
```

```
$ docker-compose restart assets web api
```
